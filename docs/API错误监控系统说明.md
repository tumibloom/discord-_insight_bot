# API错误监控系统文档

## 概述

QA机器人现在集成了完整的API错误监控和管理员私信通知系统，可以实时监控AI服务API调用的错误情况，并在发生问题时及时通知管理员。

## 主要功能

### 1. 错误自动检测和分类

系统会自动检测以下类型的API错误：

- **关键错误 (Critical)** - 立即通知
  - 连接拒绝、超时、网络不可达
  - 5xx服务器错误 (500, 502, 503, 504)
  - 认证失败、API密钥无效
  - 配额超限、速率限制

- **高频错误 (High)** - 3次后通知
  - 4xx客户端错误 (400, 401, 403, 429)
  - 请求格式错误

- **中等错误 (Medium)** - 5次后通知
  - 超时错误、连接错误
  - JSON解析错误
  - 上下文长度限制

- **低级错误 (Low)** - 10次后通知
  - 其他未分类错误

### 2. 智能通知机制

- **阈值触发**: 根据错误严重程度设置不同的通知阈值
- **冷却时间**: 同类错误5分钟内只通知一次，避免刷屏
- **私信通知**: 自动向所有配置的管理员发送私信
- **详细信息**: 包含错误类型、发生次数、用户信息、建议操作等

### 3. 数据库记录

系统会在数据库中记录：
- API错误详情和统计
- 管理员通知历史
- 错误发生趋势分析

## 管理员命令

### `/api-errors [hours]`
查看API错误统计报告
- `hours`: 统计最近多少小时的错误（默认24小时）
- 显示错误总数、按类型分布、按严重程度分布、最近错误

### `/system-status`
查看系统整体状态
- AI服务状态（Gemini、自定义API）
- 机器人连接状态
- 功能配置状态
- 错误监控状态

### `/notification-history [limit]`
查看管理员通知历史
- `limit`: 显示记录数量（默认20条）
- 包含通知类型、发送状态、时间等

### `/test-notification`
测试管理员通知功能
- 发送测试通知到所有管理员
- 验证私信通知是否正常工作

## 配置要求

### 1. 环境变量

```env
# 管理员用户ID（必需）
ADMIN_USERS=123456789,987654321

# Discord机器人Token（必需）
DISCORD_TOKEN=your_discord_token

# AI服务配置（至少一个）
GEMINI_API_KEY=your_gemini_key
# 或
CUSTOM_API_ENDPOINT=https://your.api.com
CUSTOM_API_KEY=your_api_key
CUSTOM_API_MODEL=gpt-4o-mini
```

### 2. 权限要求

管理员需要有以下权限：
- 能够接收私信（DM设置允许服务器成员私信）
- 在服务器中有使用斜杠命令的权限

## 通知示例

当API发生错误时，管理员会收到类似以下的私信：

```
🚨 API错误监控警报

错误类型: custom_api_error
发生次数: 3 次
最新发生时间: 刚刚

错误详情:
HTTP 500: Internal Server Error

API端点: https://api.example.com/chat/completions
触发用户: UserName (123456789)

💡 建议操作:
• 等待API服务恢复
• 考虑使用备用API端点
• 监控官方状态页面
```

## 错误处理流程

1. **错误发生**: AI客户端调用失败
2. **错误记录**: 系统记录错误详情到数据库
3. **严重程度评估**: 根据错误类型和内容分类
4. **阈值检查**: 判断是否达到通知条件
5. **冷却检查**: 避免重复通知
6. **私信发送**: 向所有管理员发送通知
7. **记录通知**: 在数据库中记录通知状态

## 监控数据

系统会持续跟踪：
- 错误发生频率和趋势
- 不同API端点的稳定性
- 用户请求成功率
- 通知发送成功率

## 故障排除

### 常见问题

1. **收不到通知**
   - 检查ADMIN_USERS配置是否正确
   - 确认Discord私信设置允许接收消息
   - 查看机器人日志中的错误信息

2. **通知过于频繁**
   - 系统有5分钟冷却时间
   - 可能是API服务持续出现问题
   - 检查API配置和网络连接

3. **统计数据不准确**
   - 数据基于最近的错误记录
   - 重启机器人会清空内存统计
   - 数据库统计是持久的

### 调试命令

```bash
# 测试API错误监控系统
cd discord_qa_bot
python test_api_monitor.py

# 查看机器人日志
tail -f logs/discord_qa_bot.log
```

## 安全考虑

- 通知内容不包含敏感的API密钥或详细错误堆栈
- 用户信息仅显示用户名和ID
- 错误消息长度有限制，避免泄露过多信息

## 扩展功能

可以考虑的未来增强：
- 邮件通知支持
- 错误趋势图表
- 自动API切换
- 错误恢复建议
- 性能指标监控

## 维护建议

1. **定期检查**: 每周查看错误统计
2. **清理数据**: 定期清理过旧的错误记录
3. **配置更新**: 根据使用情况调整通知阈值
4. **测试通知**: 定期测试通知功能是否正常

---

通过这个API错误监控系统，管理员可以及时发现和处理API相关问题，确保QA机器人的稳定运行。
